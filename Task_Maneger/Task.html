<!doctype html>
<html lang="ja">
<head>
  <link rel="icon" href="../keep_out/Game_Developing.png" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜TODOï¼ˆç¹°ã‚Šè¿”ã—ãƒ»ä¸€æ‹¬å‰Šé™¤å¯¾å¿œï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;margin:24px;background:#f7f8fb}
    .wrap{max-width:720px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 20px rgba(30,30,60,0.06)}
    h1{margin:0 0 12px;font-size:20px}
    .input-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    input[type=text],input[type=datetime-local],input[type=number]{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
    select{padding:10px;border:1px solid #ddd;border-radius:8px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    ul{list-style:none;padding:0;margin:0}
    li{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #f0f2f6;flex-wrap:wrap}
    li .txt{flex:1}
    .small{font-size:12px;color:#666}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .muted{background:#eee;color:#333}
    .date-label{font-size:12px;color:#888;margin-left:8px;}
    .repeat-label{font-size:12px;color:#0a0;}
    .show-from-label{font-size:12px;color:#06a;}
    .guide {background:#f0f4ff;border-left:4px solid #2563eb;padding:10px 14px;margin-bottom:16px;border-radius:6px;font-size:14px;line-height:1.6;}
    code {background:#eef;border-radius:4px;padding:1px 4px;}
    #auto-end-label {font-size:13px;color:#333;margin:4px 0 12px 2px;}
    #bulk-controls{display:flex;gap:8px;align-items:center;margin-bottom:8px;}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜TODOï¼ˆç¹°ã‚Šè¿”ã—ãƒ»ä¸€æ‹¬å‰Šé™¤å¯¾å¿œï¼‰</h1>

    <!-- èª¬æ˜ -->
    <div class="guide">
      <strong>ä½¿ã„æ–¹ï¼š</strong>
      <ul style="margin:6px 0 0 16px;">
        <li><b>ç· åˆ‡æ—¥æ™‚ï¼š</b> æœ€åˆã®æ—¥æ™‚ã‚’è¨­å®šã€‚</li>
        <li><b>ç¹°ã‚Šè¿”ã—è¨­å®šï¼š</b> <code>æ¯é€±</code>ãƒ»<code>2é€±é–“ã”ã¨</code>ãƒ»<code>æ¯æœˆ</code>ã€‚</li>
        <li><b>ç¹°ã‚Šè¿”ã—å›æ•°ï¼š</b> çµ‚äº†æ—¥ã¯è‡ªå‹•è¨ˆç®—ã€‚</li>
        <li><b>ä½•æ—¥å‰ã‹ã‚‰è¡¨ç¤ºï¼š</b> ç· åˆ‡ã®â—¯æ—¥å‰ã‹ã‚‰è¡¨ç¤ºã€‚</li>
      </ul>
    </div>

    <!-- å…¥åŠ›æ¬„ -->
    <div class="input-row">
      <input id="todo-input" type="text" placeholder="ã‚„ã‚‹ã“ã¨ã‚’å…¥åŠ›" />
      <input id="todo-date" type="datetime-local" />
      <select id="repeat-select">
        <option value="">ç¹°ã‚Šè¿”ã—ãªã—</option>
        <option value="weekly">æ¯é€±</option>
        <option value="biweekly">2é€±é–“ã”ã¨</option>
        <option value="monthly">æ¯æœˆ</option>
      </select>
      <input id="repeat-count" type="number" min="1" value="5" placeholder="ç¹°ã‚Šè¿”ã—å›æ•°" style="max-width:120px;" />
      <input id="show-from" type="number" min="0" value="0" placeholder="ä½•æ—¥å‰ã‹ã‚‰è¡¨ç¤º" style="max-width:110px;" />
      <button id="add-btn">è¿½åŠ </button>
    </div>

    <div id="auto-end-label"></div>

    <!-- ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
    <div id="bulk-controls">
      <input type="checkbox" id="select-all"> <label for="select-all">å…¨é¸æŠ</label>
      <button id="delete-selected" class="muted">âœ” é¸æŠã—ãŸã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤</button>
    </div>

        <div class="controls">
      <button id="export-btn" class="muted">JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button id="import-btn" class="muted">JSONã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button id="save-fsa" class="muted">ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆFile System Accessï¼‰</button>
      <input id="file-input" type="file" accept="application/json" style="display:none" />
    </div>
    <!-- ãƒªã‚¹ãƒˆ -->
    <ul id="list"></ul>



    <p class="small">
      è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã® <code>localStorage</code> ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
    </p>
  </div>

  <script>
    
    const STORAGE_KEY='local_todo_bulk_v1';
    let todos=[];

    const input=document.getElementById('todo-input');
    const dateInput=document.getElementById('todo-date');
    const repeatSelect=document.getElementById('repeat-select');
    const repeatCountInput=document.getElementById('repeat-count');
    const showFromInput=document.getElementById('show-from');
    const addBtn=document.getElementById('add-btn');
    const listEl=document.getElementById('list');
    const endLabel=document.getElementById('auto-end-label');
    const selectAll=document.getElementById('select-all');
    const deleteSelected=document.getElementById('delete-selected');

    const exportBtn=document.getElementById('export-btn');
    const importBtn=document.getElementById('import-btn');
    const fileInput=document.getElementById('file-input');
    const saveFsaBtn=document.getElementById('save-fsa');
    let fileHandle=null;

    function saveToLocalStorage(){localStorage.setItem(STORAGE_KEY,JSON.stringify(todos));}
    function loadFromLocalStorage(){
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw)return;
      try{todos=JSON.parse(raw);}catch{todos=[];}
    }

    // è‡ªå‹•çµ‚äº†æ—¥
function updateAutoEndLabel(){
  const base=dateInput.value?new Date(dateInput.value):null;
  const repeat=repeatSelect.value;
  const count=Number(repeatCountInput.value)||0;
  if(!base||!repeat||count<=1){endLabel.textContent='';return;}
  let end = new Date(base);
  if(repeat === 'monthly'){
    end.setMonth(base.getMonth() + (count - 1));
  }else{
    const intervalDays=repeat==='weekly'?7:repeat==='biweekly'?14:0;
    end.setDate(base.getDate()+(count-1)*intervalDays);
  }
  endLabel.textContent=`çµ‚äº†æ—¥ï¼š${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
}
    dateInput.addEventListener('change',updateAutoEndLabel);
    repeatSelect.addEventListener('change',updateAutoEndLabel);
    repeatCountInput.addEventListener('input',updateAutoEndLabel);

    function shouldShowTask(t){
      if(!t.date||t.done)return true;
      const showFrom=Number(t.showFrom)||0;
      const today=new Date();today.setHours(0,0,0,0);
      const deadline=new Date(t.date);deadline.setHours(0,0,0,0);
      const showDate=new Date(deadline);showDate.setDate(deadline.getDate()-showFrom);
      return today>=showDate;
    }

function render(){
  listEl.innerHTML='';
  todos.sort((a,b)=>(a.date||'').localeCompare(b.date||''));
  todos.forEach((t,i)=>{
    const li=document.createElement('li');
    const chkMain=document.createElement('input');
    chkMain.type='checkbox';chkMain.className='select-task';chkMain.dataset.index=i;

    const done=document.createElement('input');
    done.type='checkbox';done.checked=!!t.done;
    done.addEventListener('change',()=>{t.done=done.checked;saveToLocalStorage();render();});

    const span=document.createElement('span');
    span.className='txt';span.textContent=t.text;
    if(t.done) span.style.textDecoration='line-through';

    if(t.date){
      const dateLabel=document.createElement('span');
      dateLabel.className='date-label';

      // ğŸ“… æ—¥ä»˜ã‚’ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§è¡¨ç¤ºï¼†æ›œæ—¥ã‚’è¿½åŠ 
      const d = new Date(t.date);
      const weekdays = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
      const wd = weekdays[d.getDay()];
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      dateLabel.textContent = `æœŸé™:${y}/${m}/${day}(${wd}) ${hh}:${mm}`;
      li.appendChild(dateLabel);
    }

    if(t.repeat){
      const label={weekly:'ï¼ˆæ¯é€±ï¼‰',biweekly:'ï¼ˆ2é€±é–“ã”ã¨ï¼‰',monthly:'ï¼ˆæ¯æœˆï¼‰'}[t.repeat];
      const rep=document.createElement('span');
      rep.className='repeat-label';rep.textContent=label;
      li.appendChild(rep);
    }

    if(t.autoEndLabel){
      const el=document.createElement('span');
      el.className='date-label';
      el.textContent=`çµ‚äº†æ—¥:${t.autoEndLabel}`;
      li.appendChild(el);
    }

    const edit=document.createElement('button');
    edit.textContent='ç·¨é›†';edit.className='muted';
    edit.addEventListener('click',()=>{const v=prompt('ç·¨é›†ã—ã¦ãã ã•ã„',t.text);if(v!==null){t.text=v.trim();saveToLocalStorage();render();}});
    const del=document.createElement('button');
    del.textContent='å‰Šé™¤';del.className='muted';
    del.addEventListener('click',()=>{if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){todos.splice(i,1);saveToLocalStorage();render();}});
    
    if(!shouldShowTask(t)){
      li.style.opacity='0.5';
      li.style.background='#f8f8f8';
    }

    li.prepend(chkMain,done,span);
    li.append(edit,del);
    listEl.appendChild(li);
  });
}

    function addTodo(text,date,repeat,repeatCount,showFrom){
      text=text.trim();if(!text)return;
      const baseDate=new Date(date);
      const repeatCountNum=Number(repeatCount)||0;
      const autoEnd=new Date(baseDate);
      const intervalDays=repeat==='weekly'?7:repeat==='biweekly'?14:repeat==='monthly'?30:0;
      autoEnd.setDate(baseDate.getDate()+(repeatCountNum-1)*intervalDays);
      const endStr=`${autoEnd.getMonth()+1}æœˆ${autoEnd.getDate()}æ—¥`;
      todos.push({
        text,done:false,createdAt:new Date().toISOString(),
        date:date||null,repeat:repeat||'',
        repeatCount:repeatCountNum,showFrom:Number(showFrom)||0,
        autoEndLabel:endStr
      });
      generateRepeatingTasks();
      saveToLocalStorage();render();
    }

function generateRepeatingTasks(){
  const newTodos = [];
  const seen = new Set();
  todos.forEach(t => {
    // é‡è¤‡é˜²æ­¢ã®ãŸã‚ã€text+date+repeatã‚’ã‚­ãƒ¼ã«
    const key = `${t.text}__${t.date}__${t.repeat}`;
    seen.add(key);
  });

  todos.forEach(t => {
    if(!t.repeat || !t.date) return;
    let intervalDays = 0;
    if(t.repeat === 'weekly') intervalDays = 7;
    if(t.repeat === 'biweekly') intervalDays = 14;
    const start = new Date(t.date);
    const baseHour = start.getHours(), baseMinute = start.getMinutes(), baseSecond = start.getSeconds();
    for(let i = 1; i < t.repeatCount; i++){
      let d = new Date(start.getTime());
      if(t.repeat === 'monthly'){
        d.setMonth(start.getMonth() + i);
      }else{
        d.setDate(start.getDate() + i * intervalDays);
      }
      d.setHours(baseHour, baseMinute, baseSecond);
      const dateStr = d.toISOString().slice(0,16);
      const key = `${t.text}__${dateStr}__${t.repeat}`;
      if(seen.has(key)) continue; // æ—¢ã«è¿½åŠ æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
      seen.add(key);
      newTodos.push({
        text: t.text, done: false, createdAt: new Date().toISOString(),
        date: dateStr, repeat: t.repeat, repeatCount: t.repeatCount,
        showFrom: t.showFrom || 0, autoEndLabel: t.autoEndLabel
      });
    }
  });
  todos = todos.filter((t, i, arr) => {
    // é‡è¤‡æ’é™¤ï¼ˆtext+date+repeatãŒåŒã˜ã‚‚ã®ã¯æœ€åˆã®1ã¤ã ã‘æ®‹ã™ï¼‰
    const key = `${t.text}__${t.date}__${t.repeat}`;
    return arr.findIndex(x => `${x.text}__${x.date}__${x.repeat}` === key) === i;
  }).concat(newTodos);
}

    addBtn.addEventListener('click',()=>{
      addTodo(input.value,dateInput.value,repeatSelect.value,repeatCountInput.value,showFromInput.value);
      input.value='';dateInput.value='';repeatSelect.value='';repeatCountInput.value='5';showFromInput.value='0';endLabel.textContent='';
    });

    // âœ… ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½
    selectAll.addEventListener('change',()=>{
      const checks=document.querySelectorAll('.select-task');
      checks.forEach(c=>c.checked=selectAll.checked);
    });

    deleteSelected.addEventListener('click',()=>{
      const checks=[...document.querySelectorAll('.select-task:checked')];
      if(checks.length===0)return alert('å‰Šé™¤ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
      if(!confirm(`${checks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
      const indices=checks.map(c=>Number(c.dataset.index)).sort((a,b)=>b-a);
      indices.forEach(i=>todos.splice(i,1));
      saveToLocalStorage();render();
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    exportBtn.addEventListener('click',()=>{
      if(todos.length===0)return alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      const blob=new Blob([JSON.stringify(todos,null,2)],{type:'application/json'});//ã“ã‚Œã§MIMEã‚¿ã‚¤ãƒ—æŒ‡å®š
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='todos.json';a.click();//
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click',()=>fileInput.click());//ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    fileInput.addEventListener('change',async ev=>{
      const f=ev.target.files[0];if(!f)return;
      try{
        const txt=await f.text();
        const parsed=JSON.parse(txt);
        if(!Array.isArray(parsed))throw new Error('é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
        if(confirm('è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚'))todos=todos.concat(parsed);else todos=parsed;
        saveToLocalStorage();render();
      }catch(err){alert('èª­ã¿è¾¼ã¿å¤±æ•—:'+err.message);}
      fileInput.value='';
    });

    saveFsaBtn.addEventListener('click',async()=>{
      if(!('showSaveFilePicker'in window)){alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éå¯¾å¿œ');return;}
      try{
        if(!fileHandle){
          fileHandle=await window.showSaveFilePicker({suggestedName:'todos.json',types:[{description:'JSON',accept:{'application/json':['.json']}}]});
        }
        const writable=await fileHandle.createWritable();
        await writable.write(JSON.stringify(todos,null,2));
        await writable.close();alert('ä¿å­˜ã—ã¾ã—ãŸ');
      }catch(e){if(e.name!=='AbortError')console.error(e);}
    });

    loadFromLocalStorage();render();
  </script>
</body>
</html>
